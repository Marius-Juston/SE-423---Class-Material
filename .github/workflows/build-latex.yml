name: Build LaTeX PDFs (TeX Live 2025) and Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '**.tex'
      - 'pdf-list.txt'
      - 'site/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # TL_DIR: Installation target
      TL_DIR: /home/runner/texlive/2025
      # TEXMFVAR: Where configuration and formats live. MUST be consistent.
      TEXMFVAR: /home/runner/texlive/2025/texmf-var
      TEXMFSYSVAR: /home/runner/texlive/2025/texmf-var
      TEXMFCONFIG: /home/runner/texlive/2025/texmf-config
      TEXMFSYSCONFIG: /home/runner/texlive/2025/texmf-config
      # NOTE: TEXMFOUTPUT removed from global scope to prevent fmtutil corruption

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache TeX Live
        id: cache-texlive
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.TL_DIR }}
            ~/.texlive2025
          key: texlive-2025-${{ runner.os }}-v4 # Bumped version key due to layout change

      - name: Install TeX Live 2025
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        run: |
          # 1. Install Dependencies (Added python3-pygments)
          sudo apt-get update && sudo apt-get install -y perl wget xz-utils python3-pygments

          # 2. Download Installer
          wget https://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar -xzf install-tl-unx.tar.gz
          TL_SRC_DIR=$(tar -tzf install-tl-unx.tar.gz | head -1 | cut -d/ -f1)

          # 3. Directory Prep
          mkdir -p ${{ env.TL_DIR }}
          mkdir -p ${{ env.TL_DIR }}/texmf-var
          mkdir -p ${{ env.TL_DIR }}/texmf-config
          
          cd "$TL_SRC_DIR"
          
          # 4. Profile (Crucial: option_sys_bin 0 avoids linking to /usr/local/bin)
          cat <<EOF > texlive.profile
          selected_scheme scheme-basic
          TEXDIR ${{ env.TL_DIR }}
          TEXMFLOCAL ${{ env.TL_DIR }}/texmf-local
          TEXMFSYSCONFIG ${{ env.TL_DIR }}/texmf-config
          TEXMFSYSVAR ${{ env.TL_DIR }}/texmf-var
          TEXMFCONFIG ${{ env.TL_DIR }}/texmf-config
          TEXMFVAR ${{ env.TL_DIR }}/texmf-var
          option_doc 0
          option_src 0
          EOF
          
          # 5. Run Install
          ./install-tl --profile=texlive.profile

      - name: Normalize TeX Live permissions
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        run: |
          chmod -R u+rwX ${{ env.TL_DIR }} || true

      - name: Configuration and Package Installation
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        run: |
          export PATH="${{ env.TL_DIR }}/bin/x86_64-linux:$PATH"
          
          # ENSURE TEXMFOUTPUT IS NOT SET HERE
          unset TEXMFOUTPUT

          # 1. Disable auto-formats to prevent latex-dev crashes
          tlmgr option create_formats 0
          
          # 2. Install Packages
          tlmgr install \
            latexmk \
            collection-latexrecommended \
            collection-latexextra \
            collection-fontsrecommended \
            collection-bibtexextra \
            amsmath \
            environ \
            minted \
            fvextra \
            catchfile \
            xcolor \
            etoolbox \
            lineno

          # 3. Manually Generate STABLE formats only
          # This will now write correctly to TEXMFVAR because TEXMFOUTPUT is unset
          fmtutil-sys --byfmt pdflatex
          fmtutil-sys --byfmt lualatex
          
          # 4. Refresh filename database
          mktexlsr

      - name: Save TeX Live Cache
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.TL_DIR }}
            ~/.texlive2025
          key: texlive-2025-${{ runner.os }}-v4

      - name: Add TeX to Path
        run: echo "${{ env.TL_DIR }}/bin/x86_64-linux" >> $GITHUB_PATH

      - name: Compile LaTeX Documents
        env:
          # We only re-introduce TEXMFOUTPUT here if strictly necessary for minted/etc.
          # However, usually latexmk -outdir handles this better.
          # If you specifically need Minted to write intermediate files elsewhere:
          TEXMFOUTPUT: ${{ github.workspace }}/texmf-output
        run: |
          mkdir -p build
          mkdir -p ${{ github.workspace }}/texmf-output
          mkdir -p "${HOME}/.config/latexminted"
          
          grep -v '^#' pdf-list.txt | while IFS= read -r texfile || [ -n "$texfile" ]; do
            [ -z "$texfile" ] && continue
            echo "Compiling $texfile..."
            out_dir="build/$(dirname "$texfile")"
            mkdir -p "$out_dir"
            
            # Using -shell-escape is required for minted
            latexmk -pdf -interaction=nonstopmode -file-line-error -halt-on-error \
              -shell-escape -outdir="$out_dir" "$texfile"
          done

      - name: Deploy to Artifacts Branch
        env:
          SAVE_LOGS: false
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout --orphan artifacts
          git rm -rf .
      
          # Extract PDFs from build/
          cd build
          if [ "$SAVE_LOGS" = "true" ]; then
            find . -type f \( -name "*.pdf" -o -name "*.log" -o -name "*.aux" \) -exec cp --parents {} .. \;
          else
            find . -type f -name "*.pdf" -exec cp --parents {} .. \;
          fi
          cd ..
      
          # Move site assets
          if [ -d "site" ]; then
            rsync -av --progress site/ .
            rm -rf site
          fi
      
          rm -rf build
      
          git add .
          git commit -m "Build: $(date +'%Y-%m-%d %H:%M:%S') - Clean Production"
          git push --force origin artifacts
