name: Build LaTeX PDFs (TeX Live 2025) and Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '**.tex'
      - 'pdf-list.txt'
      - 'site/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Moving to a user-writable directory to fix cache permission issues
      TL_DIR: /home/runner/texlive/2025
      TEXMF_OUTPUT_DIRECTORY: ${{ github.workspace }}/texmf-output
      XDG_CONFIG_HOME: ${{ github.workspace }}/.config

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache TeX Live
        id: cache-texlive
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.TL_DIR }}
            ~/.texlive2025
          key: texlive-2025-${{ runner.os }}-v2 # Incremented version key

      - name: Install TeX Live 2025
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        env:
          TEXMFVAR: ${{ env.TL_DIR }}/texmf-var
          TEXMFSYSVAR: ${{ env.TL_DIR }}/texmf-var
          TEXMFCONFIG: ${{ env.TL_DIR }}/texmf-config
          TEXMFSYSCONFIG: ${{ env.TL_DIR }}/texmf-config
          TEXMFOUTPUT: ${{ github.workspace }}/texmf-output
        run: |
          sudo apt-get update && sudo apt-get install -y perl wget xz-utils
          wget https://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar -xzf install-tl-unx.tar.gz
          TL_SRC_DIR=$(tar -tzf install-tl-unx.tar.gz | head -1 | cut -d/ -f1)

          # Ensure the directory exists
          mkdir -p ${{ env.TL_DIR }}
          mkdir -p ${{env.TL_DIR}}/texmf-var
          export TEXMFOUTPUT="${GITHUB_WORKSPACE}/texmf-output"
          mkdir -p "$TEXMFOUTPUT"

          cd "$TL_SRC_DIR"
          
          # Fully encapsulated profile
          cat <<EOF > texlive.profile
          selected_scheme scheme-basic
          TEXDIR ${{ env.TL_DIR }}
          TEXMFLOCAL ${{ env.TL_DIR }}/texmf-local
          TEXMFSYSCONFIG ${{ env.TL_DIR }}/texmf-config
          TEXMFSYSVAR ${{ env.TL_DIR }}/texmf-var
          TEXMFCONFIG ${{ env.TL_DIR }}/texmf-config
          TEXMFVAR ${{ env.TL_DIR }}/texmf-var
          option_doc 0
          option_src 0
          EOF
          
          ./install-tl --profile=texlive.profile
      - name: Normalize TeX Live permissions
        run: |
          chmod -R u+rwX ${{ env.TL_DIR }}
          chmod -R u+rwX ~/.texlive2025 || true

      - name: LaTeX Compilation
        run: |
          export PATH="${{ env.TL_DIR }}/bin/x86_64-linux:$PATH"

          # Disable automatic format generation (optional but recommended)
          tlmgr option create_formats 0
          
          ${{ env.TL_DIR }}/bin/x86_64-linux/tlmgr install \
            latexmk \
            collection-latexrecommended \
            collection-latexextra \
            collection-fontsrecommended \
            collection-bibtexextra \
            amsmath \
            environ \
            minted \
            fvextra \
            catchfile \
            xcolor \
            etoolbox \
            lineno

      - name: Save TeX Live Cache
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.TL_DIR }}
            ~/.texlive2025
          key: texlive-2025-${{ runner.os }}-v2

      - name: Finalize Path
        run: echo "${{ env.TL_DIR }}/bin/x86_64-linux" >> $GITHUB_PATH

      - name: Prepare TeX output directories for minted
        run: |
          mkdir -p "${TEXMF_OUTPUT_DIRECTORY}"
          mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/latexminted"

      - name: Compile LaTeX Documents
        run: |
          mkdir -p build
          # Removed the typo 'absenteeism;' and refined the loop
          grep -v '^#' pdf-list.txt | while IFS= read -r texfile || [ -n "$texfile" ]; do
            [ -z "$texfile" ] && continue
            echo "Compiling $texfile..."
            out_dir="build/$(dirname "$texfile")"
            mkdir -p "$out_dir"
            latexmk -pdf -interaction=nonstopmode -file-line-error -halt-on-error \
              -shell-escape -outdir="$out_dir" "$texfile"
          done

      - name: Deploy to Artifacts Branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout --orphan artifacts
          git rm -rf .
          # Use find to safely move PDFs while maintaining structure
          find build -name "*.pdf" -exec cp --parents {} . \;
          mv build/* . 2>/dev/null || true
          if [ -d "site" ]; then cp -r site/* .; fi
          
          git add .
          git commit -m "Build: $(date +'%Y-%m-%d %H:%M:%S') [pdfLaTeX 2025]"
          git push --force origin artifacts
